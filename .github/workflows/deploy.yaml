name: Deploy to Production

on:
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '*.md'
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.38.4'

jobs:
  # Stage 1: Quality checks
  quality-check:
    name: Code Quality & Tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      
      - name: Get Flutter dependencies
        run: flutter pub get
      
      - name: Run flutter analyze
        run: flutter analyze
      
      - name: Run tests
        run: flutter test --coverage
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          flags: flutter
          fail_ci_if_error: false

  # Stage 2: Deploy backend
  deploy-backend:
    name: Deploy Backend & .env
    runs-on: ubuntu-latest
    needs: quality-check
    if: success()
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.PROD_SSH_KEY }}
          ssh-auth-sock: /tmp/ssh_agent.sock
      
      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H 146.103.99.70 >> ~/.ssh/known_hosts 2>/dev/null
      
      - name: Transfer .env to server
        run: |
          cat > /tmp/.env.upload << 'ENVEOF'
          ${{ secrets.PROD_ENV_FILE }}
          ENVEOF
          
          scp -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              /tmp/.env.upload root@146.103.99.70:/tmp/.env.production.upload
      
      - name: Update .env and restart Docker
        run: |
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              root@146.103.99.70 << 'SSHEOF'
          set -e
          
          echo "üì¶ Moving .env file..."
          mv /tmp/.env.production.upload /srv/vpn-api/.env.production
          chmod 600 /srv/vpn-api/.env.production
          
          echo "üê≥ Restarting Docker services..."
          cd /srv/vpn-api
          docker compose up -d --no-deps --build web
          
          echo "‚è≥ Waiting for services to be ready..."
          sleep 5
          
          echo "üîç Checking health..."
          curl -sf http://localhost:8000/docs > /dev/null || exit 1
          echo "‚úÖ Services are healthy!"
          SSHEOF
      
      - name: Final health check
        run: |
          echo "üîç Running final health check..."
          for i in {1..10}; do
            if curl -sf http://146.103.99.70:8000/docs > /dev/null 2>&1; then
              echo "‚úÖ Backend API is responding"
              exit 0
            fi
            echo "Attempt $i/10..."
            sleep 2
          done
          echo "‚ùå Backend health check failed"
          exit 1
      
      - name: Cleanup
        if: always()
        run: rm -f /tmp/.env.upload

  # Stage 3: Build artifacts
  build-artifacts:
    name: Build Flutter Artifacts
    runs-on: ubuntu-latest
    needs: quality-check
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Build APK
        run: flutter build apk --release --obfuscate --split-debug-info=build/debug-info
      
      - name: Upload APK
        uses: actions/upload-artifact@v3
        with:
          name: app-release.apk
          path: build/app/outputs/flutter-apk/app-release.apk
          if-no-files-found: ignore
          retention-days: 7

  # Stage 4: Notifications
  notify:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [quality-check, deploy-backend, build-artifacts]
    if: always()
    
    steps:
      - name: Print summary
        run: |
          echo "================================"
          echo "üöÄ Deployment Pipeline Summary"
          echo "================================"
          echo "‚úÖ Quality Checks: ${{ needs.quality-check.result }}"
          echo "‚úÖ Backend Deploy: ${{ needs.deploy-backend.result }}"
          echo "‚úÖ Build Artifacts: ${{ needs.build-artifacts.result }}"
          echo "================================"
          
          if [ "${{ needs.deploy-backend.result }}" = "success" ]; then
            echo "‚úÖ DEPLOYMENT SUCCESSFUL!"
            echo "üåê API: http://146.103.99.70:8000"
            echo "üìö Docs: http://146.103.99.70:8000/docs"
          else
            echo "‚ùå DEPLOYMENT FAILED!"
            exit 1
          fi
